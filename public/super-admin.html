<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - MedFlow Pro</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background: var(--bg-body);
            padding: 0;
        }

        .admin-header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            box-shadow: var(--shadow-sm);
        }

        .admin-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .admin-logo span {
            color: var(--secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary);
            margin: 8px 0;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .hospital-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .hospital-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .hospital-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .hospital-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 4px;
        }

        .hospital-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .meta-item {
            font-size: 0.9rem;
        }

        .meta-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .password-badge {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 8px 16px;
            border-radius: 999px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            letter-spacing: 2px;
            font-size: 1.1rem;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
    </style>
</head>

<body>
    <!-- Password Modal -->
    <div id="passwordModal"
        style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div
            style="background: white; padding: 48px; border-radius: 16px; max-width: 400px; width: 90%; text-align: center;">
            <h2 style="margin-bottom: 8px; color: var(--secondary);">üîí Super Admin Access</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px;">Enter admin password to continue</p>
            <input type="password" id="adminPassword" placeholder="Enter password"
                style="width: 100%; padding: 14px; font-size: 1rem; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 16px;"
                onkeypress="if(event.key==='Enter') checkPassword()">
            <div id="errorMsg" style="color: var(--danger); font-size: 0.9rem; margin-bottom: 12px; display: none;">
            </div>
            <button onclick="checkPassword()" class="btn btn-primary" style="width: 100%;">Access Dashboard</button>
        </div>
    </div>

    <div id="adminContent" style="display: none;">
        <div class="admin-header">
            <div class="container">
                <div class="admin-logo"><span>MedFlow</span> Pro Admin</div>
                <button class="btn btn-sm btn-primary" onclick="window.location.reload()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="container" style="padding: 32px 24px;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üè•</div>
                    <div class="stat-value" id="totalHospitals">0</div>
                    <div class="stat-label">Total Hospitals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="activeHospitals">0</div>
                    <div class="stat-label">Active Subscriptions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">‚Çπ<span id="revenue">0</span></div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
            </div>

            <div class="filter-bar">
                <input type="text" id="searchHospitals" placeholder="üîç Search hospitals..."
                    style="flex: 1; min-width: 250px;">
                <select id="filterStatus" style="width: 200px;">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                </select>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3>Registered Hospitals</h3>
                    <button class="btn btn-sm btn-accent" onclick="window.location.href='/register-hospital.html'">+ Add
                        Hospital</button>
                </div>
                <div id="hospitalsList">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading hospitals...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/admin-password-check.js"></script>
    <script>
        let hospitals = [], users = [];
        async function loadData() {
            try {
                hospitals = await (await fetch('/api/admin/hospitals')).json();
                users = await (await fetch('/api/admin/users')).json();
                updateStats();
                displayHospitals(hospitals);
            } catch (error) { console.error('Error:', error); showToast('Error', 'Failed to load data', 'error'); }
        }
        function updateStats() {
            document.getElementById('totalHospitals').textContent = hospitals.length;
            document.getElementById('activeHospitals').textContent = hospitals.filter(h => h.subscriptionStatus === 'active').length;
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('revenue').textContent = (hospitals.filter(h => h.subscriptionStatus === 'active').length * 1500).toLocaleString('en-IN');
        }
        function displayHospitals(list) {
            const container = document.getElementById('hospitalsList');
            if (list.length === 0) { container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No hospitals registered yet.</div>'; return; }
            container.innerHTML = list.map(hospital => {
                const hospitalUsers = users.filter(u => u.hospitalId === hospital.id);
                const isActive = hospital.subscriptionStatus === 'active';
                const expiryDate = hospital.subscriptionExpiry ? new Date(hospital.subscriptionExpiry) : null;
                const daysRemaining = expiryDate ? Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                const expiryText = expiryDate ? `${expiryDate.toLocaleDateString('en-IN')} (${daysRemaining} days)` : 'Not set';
                const expiryColor = daysRemaining < 7 ? 'var(--danger)' : daysRemaining < 30 ? 'var(--warning)' : 'var(--status-completed)';

                return `<div class="hospital-card"><div class="hospital-header"><div><div class="hospital-name">${hospital.name}</div><div style="color: var(--text-muted); font-size: 0.9rem;">${hospital.email}</div></div><div style="text-align: right;"><div class="password-badge" id="password-${hospital.id}">Loading...</div><div style="margin-top: 8px;"><span class="badge ${isActive ? 'completed' : 'pending'}">${hospital.subscriptionStatus}</span></div></div></div><div class="hospital-meta"><div class="meta-item"><div class="meta-label">Phone</div><div>${hospital.phone || 'N/A'}</div></div><div class="meta-item"><div class="meta-label">Users</div><div>${hospitalUsers.length} staff members</div></div><div class="meta-item"><div class="meta-label">Registered</div><div>${new Date(hospital.createdAt).toLocaleDateString('en-IN')}</div></div><div class="meta-item"><div class="meta-label">Last Login</div><div>${hospital.lastLogin ? new Date(hospital.lastLogin).toLocaleDateString('en-IN') : 'Never'}</div></div><div class="meta-item"><div class="meta-label">Subscription Expiry</div><div style="color: ${expiryColor}; font-weight: 600;">${expiryText}</div></div></div><div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;"><button class="btn btn-sm btn-secondary" onclick="viewUsers(${hospital.id})">üë• View Users (${hospitalUsers.length})</button><button class="btn btn-sm btn-secondary" onclick="copyPassword(${hospital.id})">üìã Copy Password</button><button class="btn btn-sm btn-accent" onclick="extendSubscription(${hospital.id})">üìÖ Extend Access</button><button class="btn btn-sm btn-${isActive ? 'danger' : 'accent'}" onclick="toggleStatus(${hospital.id})">${isActive ? 'üîí Suspend' : '‚úÖ Activate'}</button></div></div>`;
            }).join('');
            list.forEach(hospital => loadHospitalPassword(hospital.id));
        }
        async function loadHospitalPassword(hospitalId) {
            try {
                const data = await (await fetch(`/api/admin/hospital-password/${hospitalId}`)).json();
                document.getElementById(`password-${hospitalId}`).textContent = data.password;
            } catch (error) { document.getElementById(`password-${hospitalId}`).textContent = 'Error'; }
        }
        function copyPassword(hospitalId) {
            navigator.clipboard.writeText(document.getElementById(`password-${hospitalId}`).textContent).then(() => showToast('Copied!', `Password copied`, 'success', 2000));
        }
        async function toggleStatus(hospitalId) {
            const hospital = hospitals.find(h => h.id === hospitalId);
            const newStatus = hospital.subscriptionStatus === 'active' ? 'expired' : 'active';
            try {
                const response = await fetch(`/api/admin/hospitals/${hospitalId}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                if (response.ok) { showToast('Success', `Hospital ${newStatus}`, 'success'); loadData(); }
            } catch (error) { showToast('Error', 'Failed to update status', 'error'); }
        }
        function viewUsers(hospitalId) {
            const hospitalUsers = users.filter(u => u.hospitalId === hospitalId);
            const hospital = hospitals.find(h => h.id === hospitalId);
            const content = `<h4>${hospital.name} - Users</h4><div style="margin-top: 16px;">${hospitalUsers.map(u => `<div style="padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;"><strong>${u.username}</strong> - ${u.role}<br><small style="color: var(--text-muted);">${u.email || 'No email'}</small></div>`).join('')}</div>`;
            showModal('Hospital Users', content);
        }
        function extendSubscription(hospitalId) {
            const hospital = hospitals.find(h => h.id === hospitalId);
            const currentExpiry = hospital.subscriptionExpiry ? new Date(hospital.subscriptionExpiry).toLocaleDateString('en-IN') : 'Not set';

            const content = `
                <h4>Extend Access - ${hospital.name}</h4>
                <p style="color: var(--text-muted); margin: 12px 0;">Current expiry: <strong>${currentExpiry}</strong></p>
                <div style="margin-top: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Quick Extend:</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-sm btn-secondary" onclick="extendByDays(${hospitalId}, 7)">+7 Days</button>
                        <button class="btn btn-sm btn-secondary" onclick="extendByDays(${hospitalId}, 30)">+30 Days</button>
                        <button class="btn btn-sm btn-secondary" onclick="extendByDays(${hospitalId}, 90)">+90 Days</button>
                        <button class="btn btn-sm btn-secondary" onclick="extendByDays(${hospitalId}, 365)">+1 Year</button>
                    </div>
                    <label style="display: block; margin: 16px 0 8px; font-weight: 600;">Or Set Specific Date:</label>
                    <input type="date" id="customExpiry" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 16px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="setCustomExpiry(${hospitalId})">Set Expiry Date</button>
                </div>
            `;
            showModal('Extend Subscription', content);
        }
        async function extendByDays(hospitalId, days) {
            try {
                const response = await fetch(`/api/admin/hospitals/${hospitalId}/expiry`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ daysToAdd: days })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Success', `Extended subscription by ${days} days`, 'success');
                    loadData();
                    closeModal();
                } else {
                    showToast('Error', data.error || 'Failed to extend subscription', 'error');
                }
            } catch (error) {
                showToast('Error', 'Failed to extend subscription', 'error');
            }
        }
        async function setCustomExpiry(hospitalId) {
            const dateInput = document.getElementById('customExpiry');
            const expiryDate = dateInput.value;

            if (!expiryDate) {
                showToast('Error', 'Please select a date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/admin/hospitals/${hospitalId}/expiry`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expiryDate })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Success', 'Subscription expiry date updated', 'success');
                    loadData();
                    closeModal();
                } else {
                    showToast('Error', data.error || 'Failed to set expiry date', 'error');
                }
            } catch (error) {
                showToast('Error', 'Failed to set expiry date', 'error');
            }
        }
        document.getElementById('searchHospitals').addEventListener('input', debounce((e) => {
            const query = e.target.value.toLowerCase();
            displayHospitals(hospitals.filter(h => h.name.toLowerCase().includes(query) || h.email.toLowerCase().includes(query)));
        }, 300));
        document.getElementById('filterStatus').addEventListener('change', (e) => {
            const status = e.target.value;
            displayHospitals(status === 'all' ? hospitals : hospitals.filter(h => h.subscriptionStatus === status));
        });
        setInterval(loadData, 30000);
    </script>
</body>

</html>